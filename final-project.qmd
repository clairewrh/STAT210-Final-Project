---
title: "Final Project"
authors: Claire Wang & Xeno Hu
---
### Introduction
Cardiovascular diseases (CVDs) are the leading cause of death in the United States, with one person dying of the disease every 34 seconds (Centers for Disease Control and Prevention, 2022). Previous research has highlighted male gender, old age, obesity, abnormal cholesterol and fasting blood glucose as important predictors for CVDs, among many others (Damen et al., 2016).

As CVD incidence continues to soar, the need for an effective predictive model cannot be overstated. Such a model could enable doctors to take preventive measures, treat patients early, or encourage individuals at high risk to adopt lifestyle changes. In this report, we aim to construct a predictive model based on the "Heart Failure Prediction Dataset" by assessing the 11 possible predictors (including chest pain type, resting blood pressure, cholesterol levels, maximum heart rate, resting ECG measurements, etc.). By doing so, we seek to enhance the scientific community's understanding of CVDs and their associated risk factors, ultimately contributing to better prevention, early identification, and management of this critical disease for both individuals and populations.

## Data Description

This “Heart Failure Prediction Dataset” includes 11 characteristics that can be utilized to anticipate the potential risk of a CVD; it is called “Heart Failure Prediction Dataset” because it is not uncommon for a CVD to lead to heart failure (Velagaleti et al., 2007). The dataset was formed by merging five heart-related datasets (the Cleveland, Hungarian, Switzerland, Long Beach VA, and Stalog Heart Dataset) based on 11 common features. This dataset is currently the largest available heart disease dataset for research purposes, consisting of 918 observations.

Source: https://www.kaggle.com/datasets/fedesoriano/heart-failure-prediction

Data Dictionary:
Age: age of the patient [years]
Sex: sex of the patient [M: Male, F: Female]
ChestPainType: chest pain type [TA: Typical Angina, ATA: Atypical Angina, NAP: Non-Anginal Pain, ASY: Asymptomatic]
RestingBP: resting blood pressure [mm Hg]
Cholesterol: serum cholesterol [mm/dl]
FastingBS: fasting blood sugar [1: if FastingBS > 120 mg/dl, 0: otherwise]
RestingECG: resting electrocardiogram results [Normal: Normal, ST: having ST-T wave abnormality (T wave inversions and/or ST elevation or depression of > 0.05 mV), LVH: showing probable or definite left ventricular hypertrophy by Estes' criteria]
MaxHR: maximum heart rate achieved [Numeric value between 60 and 202]
ExerciseAngina: exercise-induced angina [Y: Yes, N: No]
Oldpeak: oldpeak = ST [Numeric value measured in depression]
ST_Slope: the slope of the peak exercise ST segment [Up: upsloping, Flat: flat, Down: downsloping]
HeartDisease: output class [1: heart disease, 0: Normal]


```{r loading packages and data, messages = F, warning = F}
library(tidyverse)
library(tidymodels)
library(glmnet)
library(MASS)
library(leaps)
library(dplyr)
library(broom)
library(ggplot2)
library(UpSetR)
library(naniar)
data = read_csv("heart2.csv")
```

Source: https://www.kaggle.com/datasets/johnsmith88/heart-disease-dataset


## EDA
```{r check missingness}
vis_miss(data)
```
At first glance, there seems to be no missingness in the dataset. 

Upon closer examination, we discovered that 173 out of the 919 observations had a serum cholesterol level of 0 mm/dl. Since this is physiologically impossible, we concluded that these observations were actually missing cholesterol data. This meant that our dataset had missing values after all.

We decide to use complete case analysis because it is relatively easy to implement, and it can reduce bias in the estimates of the variable of interest when the missing data are missing completely at random or missing at random. Although a complete case analysis in this case would lead to a 20% sample loss, we believe that it is better than imputation because our current knowledge does not allow accurate prediction of cholesterol levels of these observations.

```{r drop cholesterol}
data$Cholesterol [data$Cholesterol ==0] <- NA
data_new <- subset(data) %>%
  drop_na()
```


```{r cvd-distribution}
ggplot(data = data_new, aes(x = HeartDisease)) +
  geom_histogram(binwidth = 0.5) 
  labs(title = "Distribution of CVD",
       subtitle = "Among Patients",
       x = "Presence of CVD",
       y = "Count")
```
The distribution of CVD in our data appears to be relatively evenly distributed between patients with and without the disease. This suggests that there are sufficient data available for both categories of the response variable to perform further statistical analysis and develop a predictive model.

Previous research has identified age, resting blood pressure, serum cholesterol, the presence of exercise-induced angina, and maximum heart rate as indicators of the presence of heart disease (Hajar, 2017). In addition, the type of chest pain (cp) is a significant factor in distinguishing between types of CVD. Therefore, we will include cp as a categorical predictor variable and conduct more exploratory data analysis on all these variables.


```{r age}
data_summary <- data_new %>%
  group_by(HeartDisease) %>%
  summarise(mean = mean(Age),
            median = median(Age),
            sd = sd(Age),
            IQR = IQR(Age))
data_summary
```

```{r table for sex }
freq_table <- table(Sex = data_new$Sex, HeartDisease = data_new$HeartDisease)
freq_table_tibble <- as_tibble(freq_table)
colnames(freq_table_tibble) <- c("Sex", "No Heart Disease", "Heart Disease")
freq_table_tibble
```

```{r box plot for age }
ggplot(data_new, aes(x = Age, y = HeartDisease, group = HeartDisease)) + 
  geom_boxplot() +
  labs(title = "Age vs. Presence of CVD",
       x = "Age",
       y = "Presence of CVD") +
  theme_bw()
```


```{r box plot for cholesterol}
ggplot(data_new, aes(x = Cholesterol, y = HeartDisease, group = HeartDisease)) +  
  geom_boxplot() +
  labs(title = "Cholesterol Distribution vs. Presence of CVD",
       x = "Serum cholestoral in mg/dl",
       y = "Presence of CVD") +
  theme_bw()
```

```{r box plot for resting blood pressure}
ggplot(data_new, aes(x = RestingBP, y = HeartDisease, group = HeartDisease)) + 
  geom_boxplot() +
  labs(title = "Resting Blood Pressure vs. Presence of CVD",
       x = "Resting blood pressure (in mm Hg on admission to the hospital)",
       y = "Presence of CVD") +
  theme_bw()
```

```{r box plot for fasting bs}
data_propbs <- data_new %>% 
  group_by(FastingBS, HeartDisease) %>%
  summarise(Freq = n()) %>%
  mutate(Prop = Freq / sum(Freq))
ggplot(data_propbs, aes(x = FastingBS, y = Prop, fill = factor(HeartDisease))) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("#619CFF", "#FF6B5B"), labels = c("No Heart Disease", "Heart Disease")) +
  labs(x = "0: Fasting BS < 120 mg/dl; 1: FastingBS > 120 mg/dl", y = "Proportion") +
  ggtitle("Normal/Abnormal Fasting Blood Sugar vs. Presence of CVD") +
  theme_bw()

```

```{r proportion plot for exercise angina}
data_prop <- data_new %>% 
  group_by(ExerciseAngina, HeartDisease) %>%
  summarise(Freq = n()) %>%
  mutate(Prop = Freq / sum(Freq))
ggplot(data_prop, aes(x = ExerciseAngina, y = Prop, fill = factor(HeartDisease))) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("#619CFF", "#FF6B5B"), labels = c("No Heart Disease", "Heart Disease")) +
  labs(x = "Presence of Exercise-induced Angina", y = "Proportion") +
  ggtitle("Presence of Exercise-induced Angina vs. Presence of CVD") +
  theme_bw()

```
```{r proportion plot for sex}
data_props <- data_new %>% 
  group_by(Sex, HeartDisease) %>%
  summarise(Freq = n()) %>%
  mutate(Prop = Freq / sum(Freq))
ggplot(data_props, aes(x = Sex, y = Prop, fill = factor(HeartDisease))) +
  geom_col(position = "dodge") +
  scale_fill_manual(values = c("#619CFF", "#FF6B5B"), labels = c("No Heart Disease", "Heart Disease")) +
  labs(x = "Sex", y = "Proportion") +
  ggtitle("Sex vs. Presence of CVD") +
  theme_bw()

```

## Methodology
This section includes a brief description of your modeling process. Explain the reasoning for the type of model you’re fitting, predictor variables considered for the model including any interactions. Additionally, show how you arrived at the final model by describing the model selection process, interactions considered, variable transformations (if needed), assessment of conditions and diagnostics, and any other relevant considerations that were part of the model fitting process.

Grading criteria
The analysis steps are appropriate for the data and research question. The group used a thorough and careful approach to select the final model; the approach is clearly described in the report. The model selection process was reasonable, and addressed any violations in model conditions were discussed and/or fixed. The model conditions and diagnostics are thoroughly and accurately assessed for their model. If violations of model conditions are still present, there was a reasonable attempt to address the violations based on the course content.


Using LASSO for variable selection
```{r var-select, message = F, warning = F}
y <- data_new$HeartDisease
x <- model.matrix(HeartDisease ~ ., data = data)
m_lasso_cv <- cv.glmnet(x, y, alpha = 1)
best_lambda <- m_lasso_cv$lambda.min
m_best <- glmnet(x, y, alpha = 1, lambda = best_lambda)
m_best$beta
summary(m_best)
```

Using stepwise method for variable selection
```{r stepwise}
m_none <- lm(HeartDisease ~ 1, data = data_new)
m_all <- lm(HeartDisease ~ ., 
            data = data)
stepAIC(m_none, 
        scope = list(lower = m_none, upper = m_all),
        data = data, direction = "both")
```

Using all subset selection (not sure if nvmax should be set to 15)
```{r all subset}
m_all <- regsubsets(HeartDisease ~ .,
                  data = data_new,
                  nbest = 1, nvmax = 15)
summary(m_all)
summary(m_all)$cp
```

Notes:

Why all subset? Maybe all of the predictors seem to make sense, we don't want to select manually based on literature

 #11 has the lowest CP score (need to explain what cp means!and why we select based on cp score)
11: Age, sex, chest pain, resting bp, fasting bs, exercise angina, old peak, ST slope.
did not choose: cholesterol, resting ecg, max hr

Need to figure out what old peak means, explain exercise angina, and ST slope.

#cholesterol
Research suggests that low-density lipoprotein cholesterol (LDL-C, the "bad" cholesterol) is not the best predictor of risk for a major coronary event in people who are generally healthy otherwise.

#resting ecg
The variable "RestingECG" may not be the best predictor of heart disease because it is only measuring the resting electrocardiogram results. Many people with heart disease may have a normal resting electrocardiogram, while others without heart disease may show abnormalities in their resting electrocardiogram. In contrast, other variables in the dataset, such as "ExerciseAngina" and "Oldpeak", are more directly related to the physiological response to exercise, which can be a stronger predictor of heart disease. Additionally, "RestingECG" only provides information about the electrical activity of the heart at rest, while "ExerciseAngina" provides information about the heart's response to physical stress, which can be a more sensitive indicator of heart disease.

#max hr
Max heart rate is not the best predictor of heart disease because it is highly confounded by age. As we age, our maximum heart rate decreases, so older individuals will have lower maximum heart rates even if they are healthy.

#exercise angina
Exercise-induced angina refers to chest pain or discomfort that occurs during physical activity, such as exercise, and is usually a result of reduced blood flow to the heart. It can be a symptom of underlying heart disease, such as coronary artery disease, which can be caused by the buildup of plaque in the arteries that supply the heart with blood. Therefore, the presence or absence of exercise-induced angina can be a useful diagnostic tool in identifying individuals at risk for or already suffering from heart disease.

#old peak
The variable "Oldpeak" refers to the ST segment depression induced by exercise relative to rest. It is a numeric variable that measures the difference in the ST segment of an electrocardiogram (ECG) before and after exercise. A positive value of Oldpeak indicates that the ST segment is depressed during exercise compared to at rest, which can be a sign of ischemia (insufficient blood flow) to the heart. The greater the magnitude of the depression, the more severe the ischemia. Therefore, Oldpeak is a useful predictor of the likelihood of heart disease and can be used in models to predict the risk of heart failure.

#st slope
The variable “ST_Slope” makes sense to include, as the ST segment exercise test, is one of the most widely used tests to screen for CVDs. Either depression (horizontal or downsloping) in the slope often suggests presence of CAD and warrants further management (Lim, 2016).

#the 4 interactions that i added
Age and Sex: Studies have shown that the relationship between age and heart disease risk may differ by sex, with women generally having a later onset of heart disease compared to men.

Chest Pain Type and Sex: Some studies suggest that there may be differences in the way men and women experience chest pain during a heart attack, which could potentially impact the predictive power of chest pain type in a heart disease model.

Exercise Angina and Oldpeak: Exercise-induced angina and ST depression during exercise are both markers of ischemia (reduced blood flow to the heart), and may therefore be related to each other in predicting heart disease risk.

Oldpeak and ST Slope: The shape of the ST segment during exercise can be indicative of different types of ischemia, and may therefore have a complex relationship with the severity of heart disease risk as measured by the degree of ST depression (Oldpeak).

### Model attempts
```{r logistic regression using #11 from all subset}
m1 <- glm(HeartDisease ~ Age + Sex + ChestPainType + RestingBP + FastingBS + 
            ExerciseAngina + Oldpeak + ST_Slope, 
          data = data_new,
          family = "binomial")
tidy(m1)
m1_aug <- augment(m1)
```

Using a 0.05 significance level, it looks like the p-values of FastingBS & RestingBP are insignificant. Take these two predictors out:

```{r logistic regression using from all subset and i added 4 interactions}
m2 <- glm(HeartDisease ~ Age + Sex + ChestPainType + ExerciseAngina + 
           + Oldpeak + ST_Slope + Age*Sex + Sex*ChestPainType + ExerciseAngina*ChestPainType + Oldpeak*ST_Slope, 
          data = data_new,
          family = "binomial")
tidy(m2)
m2_aug <- augment(m2)
```

```{r logistic regression using all predictors}
m3 <- glm(HeartDisease ~ ., 
          data = data_new,
          family = "binomial")
tidy(m3)
m3_aug <- augment(m3)
```

``` {r ROC curve for model m1}

m1_aug <- m1_aug %>% 
  mutate(prob = exp(.fitted)/(1 + exp(.fitted)),
         pred_leg = ifelse(prob > 0.5, "Heart Disease", "No Heart Disease")) %>% 
  dplyr::select(.fitted, prob, pred_leg, HeartDisease)

m1_aug %>% 
  roc_curve(
    truth = as.factor(HeartDisease),
    prob, 
    event_level = "second"
  ) %>% 
  autoplot()

m1_aug %>% 
  roc_auc(
    truth = as.factor(HeartDisease),
    prob, 
    event_level = "second"
  )

table(m1_aug $pred_leg, m1_aug $HeartDisease)
``` 

``` {r ROC curve for model m2}

m2_aug <- m2_aug %>% 
  mutate(prob = exp(.fitted)/(1 + exp(.fitted)),
         pred_leg = ifelse(prob > 0.5, "Heart Disease", "No Heart Disease")) %>% 
  dplyr::select(.fitted, prob, pred_leg, HeartDisease)

m2_aug %>% 
  roc_curve(
    truth = as.factor(HeartDisease),
    prob, 
    event_level = "second"
  ) %>% 
  autoplot()

m2_aug %>% 
  roc_auc(
    truth = as.factor(HeartDisease),
    prob, 
    event_level = "second"
  )

table(m2_aug $pred_leg, m2_aug $HeartDisease)
``` 

``` {r ROC curve for model m3}

m3_aug <- m3_aug %>% 
  mutate(prob = exp(.fitted)/(1 + exp(.fitted)),
         pred_leg = ifelse(prob > 0.5, "Heart Disease", "No Heart Disease")) %>% 
  dplyr::select(.fitted, prob, pred_leg, HeartDisease)

m3_aug %>% 
  roc_curve(
    truth = as.factor(HeartDisease),
    prob, 
    event_level = "second"
  ) %>% 
  autoplot()

m3_aug %>% 
  roc_auc(
    truth = as.factor(HeartDisease),
    prob, 
    event_level = "second"
  )
``` 

## Results
This is where you will output the final model with any relevant model fit statistics. Describe the key results from the model. The goal is not to interpret every single variable in the model but rather to show that you are proficient in using the model output to address the research questions, using the interpretations to support your conclusions. Focus on the variables that help you answer the research question and that provide relevant context for the reader.

Grading criteria
The model fit is clearly assessed, and interesting findings from the model are clearly described. Interpretations of model coefficients are used to support the key findings and conclusions, rather than merely listing the interpretation of every model coefficient. If the primary modeling objective is prediction, the model’s predictive power is thoroughly assessed.

## Discussion
In this section you’ll include a summary of what you have learned about your research question along with statistical arguments supporting your conclusions. In addition, discuss the limitations of your analysis and provide suggestions on ways the analysis could be improved. Any potential issues pertaining to the reliability and validity of your data and appropriateness of the statistical analysis should also be discussed here. Lastly, this section will include ideas for future work.

Our model identified the main predictors for cardiovascular disease in this dataset and quantified their impact on the likelihood of having the disease. We found that traditional factors such as cholesterol and blood pressure lose their predictive power when richer data is available, such as fluoroscopy and electrocardiogram results, presence of other diseases, chest pain, and exercise tests. However, our analysis has limitations as the dataset is not representative of the general population, but only of those admitted to hospitals for conditions that could reasonably be suspected as heart disease. Therefore, we cannot generalize our findings to the overall population. To improve the analysis, we would need better data from a broader population. However, obtaining such data may not be feasible for most people. We believe that future research should focus on developing predictive models for heart disease in the general population, as early detection can help people make lifestyle changes or seek treatment sooner.

Citations: 
Centers for Disease Control and Prevention, National Center for Health Statistics. About Multiple Cause of Death, 1999–2020. CDC WONDER Online Database website. Atlanta, GA: Centers for Disease Control and Prevention; 2022. Accessed May 1, 2023.

Damen, J. A., Hooft, L., Schuit, E., Debray, T. P., Collins, G. S., Tzoulaki, I., Lassale, C. M., Siontis, G. C., Chiocchia, V., Roberts, C., Schlüssel, M. M., Gerry, S., Black, J. A., Heus, P., van der Schouw, Y. T., Peelen, L. M., & Moons, K. G. (2016). Prediction models for cardiovascular disease risk in the general population: systematic review. BMJ (Clinical research ed.), 353, i2416. https://doi.org/10.1136/bmj.i2416

Downs, J. R., Clearfield, M., Weis, S., Whitney, E., Shapiro, D. R., Beere, P. A., Langendorfer, A., Stein, E. A., Kruyer, W., & Gotto, A. M., Jr (1998). Primary prevention of acute coronary events with lovastatin in men and women with average cholesterol levels: results of AFCAPS/TexCAPS. Air Force/Texas Coronary Atherosclerosis Prevention Study. JAMA, 279(20), 1615–1622. https://doi.org/10.1001/jama.279.20.1615

Fedesoriano. (September 2021). Heart Failure Prediction Dataset. Retrieved [May 2, 2023] from https://www.kaggle.com/fedesoriano/heart-failure-prediction.

Lim, Y. C., Teo, S. G., & Poh, K. K. (2016). ST-segment changes with exercise stress. Singapore medical journal, 57(7), 347–353. https://doi.org/10.11622/smedj.2016116

Velagaleti, R. S., & Vasan, R. S. (2007). Heart failure in the twenty-first century: is it a coronary artery disease or hypertension problem?. Cardiology clinics, 25(4), 487–v. https://doi.org/10.1016/j.ccl.2007.08.010